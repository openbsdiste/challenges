var PingPong={initialize:function(){var b=300000;delay(function(){PingPong.ping()},b)},ping:function(){jQuery.ajax({type:"POST",async:false,datatype:"json",url:"restutilisateur/ping",data:{format:"json"},success:function(b){PingPong.initialize()},error:function(b){setTimeout("window.location.href = 'default/index/ping'",100)}})}};var OutilsAccueil={initialize:function(){jQuery("#accordeonAccueil :button").bind("click",function(){Tabs.closeTab(this.id);Tabs.addTab(this.id,this.value,"challenge/reponse/"+this.id,true)})}};var ValideChallenge={lance:function(){Tabs.closeOtherTabs("modvalchal");jQuery("#confirmer").unbind("click");ValideChallenge.compte()},compte:function(){var b=jQuery("#textepublication");jQuery("<p />").append("Comptage en cours des questions et des documents... ").append(jQuery("<span />").attr("id","cpte")).appendTo(b);jQuery.ajax({type:"POST",async:false,datatype:"json",url:"restutilisateur/validation",data:{format:"json",action:"compte"},success:function(a){jQuery("#cpte",b).empty().append("Ok.");var d=jQuery("<span />").attr("id","qstions");jQuery("<p />").append("Validation des réponses... reste ").append(d).append(" réponse(s).").appendTo(b);jQuery("#publicationProgress").progressbar({max:a.data.questions.length+a.data.documents.length+1,value:a.data.questions.length+a.data.documents.length+1});ValideChallenge.question(a.data.questions,a.data.documents)},error:function(a){jQuery("#cpte",b).empty().append("Ko.");jQuery("<br /><h2>ERREUR : Abandon.</h2>").appendTo(b)}})},question:function(k,l){var h=jQuery("#textepublication");var g=true;while(k.length&&g){jQuery("#publicationProgress").progressbar({value:k.length+l.length+1});jQuery("#qstions").empty().append(k.length);document.getElementById("qstions").innerHTML=k.length;var i=k.pop();jQuery.ajax({type:"POST",async:false,datatype:"json",url:"restutilisateur/validation",data:{format:"json",action:"question",id:i},success:function(){},error:function(a){jQuery("<br /><h2>ERREUR sur "+i+" : Abandon.</h2>").appendTo(h);g=false}})}if(g){jQuery("#qstions",h).empty().append("0");var j=jQuery("<span />").attr("id","dcuments");jQuery("<p>").append("Validation des documents... reste ").append(j).append(" document(s).").appendTo(h);ValideChallenge.document(l)}},document:function(j){var g=jQuery("#textepublication");var d=true;while(j.length&&d){jQuery("#publicationProgress").progressbar({value:j.length+1});jQuery("#dcuments").empty().append(j.length);var h=j.pop();jQuery.ajax({type:"POST",async:false,datatype:"json",url:"restutilisateur/validation",data:{format:"json",action:"document",id:h.q,nom:h.nom},success:function(){},error:function(a){jQuery("<br /><h2>ERREUR sur "+h.q+"-"+h.nom+" : Abandon.</h2>").appendTo(g);d=false}})}if(d){jQuery("#dcuments",g).empty().append("0");var i=jQuery("<span />").attr("id","ovrture");jQuery("<p />").append("Validation du challenge... ").append(i).appendTo(g);ValideChallenge.ouverture()}},ouverture:function(){var b=jQuery("#textepublication");jQuery.ajax({type:"POST",async:false,datatype:"json",url:"restutilisateur/validation",data:{format:"json",action:"ouvre"},success:function(a){jQuery("#publicationProgress").progressbar({value:0});jQuery("#ovrture",b).empty().append("Ok.");jQuery("<br /><h2>Terminé !</h2>").appendTo(b);jQuery("<p>Redirection vers la page d'accueil...").appendTo(b);setTimeout("window.location.href = '"+Global.baseUrl+"'",2000)},error:function(a){jQuery("#ovrture",b).empty().append("Ko.");jQuery("<br /><h2>ERREUR : Abandon.</h2>").appendTo(b)}})}};var DeleteDocumentsReponse={initialize:function(){jQuery(".deletefilereponse").unbind("click").on("click",function(e){var d=e.target.attributes.qid.nodeValue;var f=e.target.attributes.filename.nodeValue;jQuery.ajax({type:"DELETE",datatype:"json",url:"restutilisateur/documents",data:{format:"json",qid:d,fic:f},success:function(a){Preview.showDocumentsReponseClub(a.data.id,a.data.documents,a.data.statut);DeleteDocumentsReponse.initialize()},error:function(a){Global.showError(a,"msg_sans_info","msg_erreur_tree")}})})}};var QuestionForms={initialize:function(b){Global.setAccordion("accordeonReponse"+b);if(jQuery("#saisie"+b).length){Global.addEditorInstance("saisie"+b);Global.addEditorInstance("saisieinterne"+b);jQuery("#textes"+b).ajaxForm({dataType:"json",semantic:true,beforeSerialize:QuestionForms.beforeSerializeTextes,success:QuestionForms.processTextes,error:QuestionForms.cancelJson});jQuery("#notesinternes"+b).ajaxForm({dataType:"json",semantic:true,beforeSerialize:QuestionForms.beforeSerializeNotes,success:QuestionForms.processNotes,error:QuestionForms.cancelJson});jQuery("#documents"+b).ajaxForm({dataType:"json",semantic:true,beforeSend:QuestionForms.beforeSendDocuments,uploadProgress:QuestionForms.uploadProgressDocuments,complete:QuestionForms.processDocuments})}},beforeSerializeTextes:function(e,d){var f=e[0].id.substr(6);jQuery("#texte"+f).val(jQuery("#saisie"+f).html());return true},processTextes:function(b){Global.showMessage("Texte pris en compte")},beforeSerializeNotes:function(e,d){var f=e[0].id.substr(13);jQuery("#noteinterne"+f).val(jQuery("#saisieinterne"+f).html());return true},processNotes:function(b){Global.showMessage("Notes prises en compte")},beforeSendDocuments:function(){var f=this.url.substr(29);var d=jQuery("#docprogress"+f);var e=jQuery(".progress-label",d);d.progressbar({value:false,change:function(){e.text(d.progressbar("value")+" %")},complete:function(){e.text("terminé !")}})},uploadProgressDocuments:function(j,h,k,l){var i=this.url.substr(29);var g=jQuery("#docprogress"+i);g.progressbar("value",l)},processDocuments:function(c){var d=jQuery.parseJSON(c.responseText).data;jQuery("#docprogress"+d.id).progressbar("value",100);jQuery("#document"+d.id).val("");Preview.showDocumentsReponseClub(d.id,d.documents,d.statut);DeleteDocumentsReponse.initialize()},cancelJson:function(b){Global.showError(b,"Erreur de sauvegarde","erreur")}};jQuery(document).ready(function(){jQuery("#contenuPrincipal").layout({defaults:{applyDefaultStyles:true,size:"auto",contentSelector:".content"},west:{minSize:60,spacing_open:10,spacing_closed:10,resizable:true,slidable:true,togglerTip_open:Global.tr("open_pane"),togglerTip_closed:Global.tr("close_pane"),resizerTip:Global.tr("resize_pane"),hideTogglerOnSlide:false,fxName:"slide",fxSpeed_open:1000,fxSpeed_close:1000,fxSettings_open:{easing:"easeInQuint"},fxSettings_close:{easing:"easeOutQuint"}},center:{spacing_open:1,togglerLength_open:0,togglerLength_closed:-1,resizable:false,slidable:false,fxName:"none"}});jQuery("#layoutCenter").css("overflow","hidden");jQuery("#questiontree").jstree({json_data:{ajax:{url:"restful/tree",datatype:"json",contentType:"application/json charset=utf-8",data:function(a){return{operation:"getChildren",id:a.attr?a.attr("id").replace("node_",""):1}},dataFilter:function(a){var d=JSON.stringify(JSON.parse(a).data);return d},error:function(a){Global.showError(a,"msg_sans_info","msg_erreur_tree")}}},themes:{theme:"classic"},ui:{initially_select:["node_1"]},core:{},plugins:["themes","json_data","ui"]}).bind("select_node.jstree",function(h,g){var f="";for(var a=0;a<g.args[0].childNodes.length;a++){f+=g.args[0].childNodes[a]["textContent"]}Tabs.addQuestionsTab(g.rslt.obj[0]["id"],f.trim())});Tabs.initTabs("reponse");var b=Global.getEditor();b.setPanel("nicCommonPanel");jQuery("#preview").on("click",function(){Tabs.addTab("chalentier","Le Challenge","challenge/index/complet",true)});PingPong.initialize()});